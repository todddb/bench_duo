#!/bin/sh
# scripts/duo: Manage bench_duo Flask-SocketIO server on port 5050

APP_HOME="$(cd "$(dirname "$0")/.." && pwd)"
PID_FILE="$APP_HOME/run/bench_duo.pid"
LOG_FILE="$APP_HOME/logs/bench_duo.log"

start_app() {
    if [ -f "$PID_FILE" ] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
        echo "bench_duo already running (PID $(cat "$PID_FILE"))"
        exit 1
    fi
    echo "Starting bench_duo..."
    mkdir -p "$APP_HOME/run" "$APP_HOME/logs"
    cd "$APP_HOME" || exit 1
    # Activate virtual environment and start app on port 5050
    . .venv/bin/activate
    PORT=5050 nohup python run.py >>"$LOG_FILE" 2>&1 &
    PID=$!
    echo "$PID" > "$PID_FILE"
    echo "Started bench_duo (PID $PID), logging to $LOG_FILE"
}

stop_app() {
    if [ ! -f "$PID_FILE" ]; then
        echo "No PID file found. bench_duo not running?"
        exit 0
    fi
    PID=$(cat "$PID_FILE")
    if kill -0 "$PID" 2>/dev/null; then
        echo "Stopping bench_duo (PID $PID)..."
        kill "$PID"
        sleep 1
    fi
    if kill -0 "$PID" 2>/dev/null; then
        echo "Force killing bench_duo (PID $PID)..."
        kill -9 "$PID"
    fi
    rm -f "$PID_FILE"
    echo "Stopped bench_duo."
}

case "$1" in
    start)
        start_app
        ;;
    stop)
        stop_app
        ;;
    restart)
        stop_app
        start_app
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
        ;;
esac
